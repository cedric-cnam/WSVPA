% !TEX root = main.tex
%
% Proof of Proposition closure swA by swT
%
Let $T = \< Q, \init_T, \bar{\wei}, \final_T >$,
where $\bar{\wei}$ contains $\wei_{10}$, $\wei_{01}$, and $\wei_{11}$,
from $Q \times Q$ into respectively
$\Phi_{\Sigma}$, $\Phi_{\Delta}$, and $\Phi_{\Sigma, \Delta}$,
and let $A = \< P, \init_A, \wei_1, \final_A >$
with $\wei_1: Q \times Q \to \Phi_{\Sigma}$.
The state set of $B_{A, T}$ will be $Q' = P \times Q$.

The entering, leaving and transition functions of $B_{A, T}$ will
simulate synchronized computations of $A$ and $T$,
while reading an output word of $\Delta^*$.
%
Its state entering functions is defined
for all $\<p_1, q_1> \in Q'$, %$p_1 \in P$, $q_1 \in Q$
by $\init'(p_1, q_1) = \init_A(p_1) \otimes \init_T(q_1)$.
%
The transition function $\wei'_1$ will roughly perform
a synchronized product of transitions defined by $\wei_1$,
$\wei_{01}$ ($T$ reading in output word and not an input word)
and $\wei_{11}$ ($T$ reading both an input word and an output word).
%
Moreover, $\wei'_1$ also needs to simulate transitions
defined by $\wei_{10}$: $T$ reading in input word and not an output word.
Since $B_{A, T}$  will read only in the output word, such a transition corresponds
to an $\varepsilon$-transition of $\SWA$.
But $\SWA$ have been defined without $\varepsilon$-transitions.
Therefore, in order to take care of this case, we perform an on-the-fly
suppression of $\varepsilon$-transition in the $\SWA$ in construction,
following the algorithm~1 of~\cite{LombardySakarovitch12ciaa}.
%
% Initialize state leaving functions i
%and $\final'(p, q) = \final_A(p) \otimes \final_T(q)$.

%Every transition of $B_{A, T}$ will
%simulate a sequence of transitions of $T$ performing the following steps:
%advance in the input word while staying immobile in the output word,
%and then make one step in the output word (and advance in the input word or not).

\noindent
Initially, for all $p_1, p_2 \in P$, and $q_1, q_2 \in Q$, let
\[
\begin{array}{rcl}
\wei'_1\bigl( \< p_1, q_1>, \< p_2, q_2>\bigr) & = &
{\displaystyle\bigoplus_{p_1 = p_2}} \wei_{01}(q_1, q_2)
\oplus \wei_1(p_1, p_2) \otimes_1 \wei_{11}(q_1, q_2)\\
%
\final'(p_1, q_1) & = & \final_A(p_1) \otimes \final_T(q_1)
\end{array}
\]
We recall that by convention, 
${\displaystyle\bigoplus_{p_1 = p_2}} \wei_{01}(q_1, q_2)$
is equal to $\zero$ if $p_1 \neq p_2$.


\noindent
Then, we iterate the following updates for all $p_1, p_2, p_3\in P$ and $q_1, q_2, q_3 \in Q$:
\[
\begin{array}{rcl}
\wei'_1\bigl( \< p_1, q_1>, \< p_3, q_3>\bigr) & \opluseq &
%\displaystyle\bigoplus_{\Sigma} 
\wei_{1}(p_1, p_2)
\otimes \wei_{10}(q_1, q_2)
\otimes \wei'_1\bigl( \< p_2, q_2>, \< p_3, q_3>\bigr)\\
%
\final'(p_2, q_2) & \opluseq &
%\displaystyle\bigoplus_{\Sigma} 
\wei_{1}(p_1, p_2)
\otimes \wei_{10}(q_1, q_2)
\otimes \final'(p_1, q_1)
\end{array}
\]
In both cases, 
the weight $\wei_{1}(p_1, p_2) \otimes \wei_{10}(q_1, q_2)$
corresponds to the weight of an $\varepsilon$-transition 
that reads a symbol $a$ in the input word and does not move in the output word,
i.e. the synchronization of 
a transition $\wei_{1}(p_1, a, p_2)$ of $A$ and 
a transition $\wei_{10}(q_1, a, \varepsilon, q_2)$ of $T$.

The iteration stops when it does not change the value of $\wei'_1$.
\florent{proof correctness (app)}
%
%
% old version
%
%\noindent
%The entering, leaving and transition functions of $B_{A, T}$ will
%simulate synchronized computations of $A$ and $T$,
%while reading an output word of $\Delta^*$.
%%
%Its state entering functions is defined
%for all $\<p_1, q_1> \in Q'$, %$p_1 \in P$, $q_1 \in Q$
%by $\init'(p_1, q_1) = \init_A(p_1) \otimes \init_T(q_1)$.
%%
%The transition function $\wei'_1$ will roughly perform
%a synchronized product of transitions defined by $\wei_1$,
%$\wei_{01}$ ($T$ reading in output word and not an input word)
%and $\wei_{11}$ ($T$ reading both an input word and an output word).
%%
%Moreover, $\wei'_1$ also needs to simulate transitions
%defined by $\wei_{10}$: $T$ reading in input word and not an output word.
%Since $B_{A, T}$  will read only in the output word, such a transition corresponds
%to an $\varepsilon$-transition of $\SWA$.
%But $\SWA$ have been defined without $\varepsilon$-transitions.
%Therefore, in order to take care of this case, we perform an on-the-fly
%suppression of $\varepsilon$-transition in the $\SWA$ in construction,
%following the algorithm of~\cite{LombardySakarovitch12ciaa}.
%%
%% Initialize state leaving functions i
%%and $\final'(p, q) = \final_A(p) \otimes \final_T(q)$.
%
%%Every transition of $B_{A, T}$ will
%%simulate a sequence of transitions of $T$ performing the following steps:
%%advance in the input word while staying immobile in the output word,
%%and then make one step in the output word (and advance in the input word or not).
%
%\noindent
%Initially, for all $p_1, p_2 \in P$, and $q_1, q_2 \in Q$, let
%\[
%\begin{array}{rcl}
%\wei'_1\bigl( \< p_1, q_1>, \< p_2, q_2>\bigr) & = &
%\wei_1(p_1, p_2) \otimes
%\bigl[
%\wei_{01}(q_1, q_2)
%\oplus
%\displaystyle\bigoplus_{\Sigma}
%\wei_{11}(q_1, q_2)
%\bigr]\\
%\final'(p_1, q_1) & = & \final_A(p_1) \otimes \final_T(q_1)
%\end{array}
%\]
%
%\noindent
%Then, we iterate the following for all $p_1\in P$ and $q_1, q_2 \in Q$:
%for all $p_2\in P$ and $q_3 \in Q$,
%\[
%\begin{array}{rcl}
%\wei'_1\bigl( \< p_1, q_1>, \< p_2, q_3>\bigr) & \opluseq &
%\displaystyle\bigoplus_{\Sigma} \wei_{10}(q_1, q_2)
%\otimes
%\wei'_1\bigl( \< p_1, q_2>, \< p_2, q_3>\bigr)\\
%\final'(p_1, q_1) & \opluseq &
%\displaystyle\bigoplus_{\Sigma} \wei_{10}(q_1, q_2)
%\otimes \final'(p_1, q_2)
%\end{array}
%\]